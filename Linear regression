
install.packages("mltools")
install.packages("Metrics")
install.packages('splitstackshape')
install.packages("caret")
install.packages("janitor")
library(readr)
library(dplyr)
library(lubridate)
library(tidyverse)

library(mltools)
library(Metrics)


LA <- read.csv("LA_Listings(1).csv")
summary(LA)

LA$Street <- as.factor(LA$Street)
LA$City <- as.factor(LA$City)
LA$Amenities <-as.factor(LA$Amenities)
LA$Property_type<- as.factor(LA$Property_type)
LA$Room_type<- as.factor(LA$Room_type)
LA$Country<- as.factor(LA$Country)
LA$State<- as.factor(LA$State)
LA$Neighbourhood_cleansed<- as.factor(LA$Neighbourhood_cleansed)

#format the date

library(lubridate)
LA$Calendar_last_scraped<-mdy(LA$Calendar_last_scraped)
LA$Last_Review_Date <-mdy(LA$Last_Review_Date)

#Dummy coded
LA$Host_Is_Superhost <- ifelse(LA$Host_Is_Superhost == "TRUE", 1,0)

#transfer NA into mean/median of the variables
LA$Host_Response_Rate <- ifelse(is.na(LA$Host_Response_Rate), mean(LA$Host_Response_Rate,na.rm=TRUE),LA$Host_Response_Rate)
LA$Host_total_listings_count <- ifelse(is.na(LA$Host_total_listings_count), median(LA$Host_total_listings_count,na.rm=TRUE),LA$Host_total_listings_count)
LA$Accommodates <-ifelse(is.na(LA$Accommodates), median(LA$Accommodates,na.rm=TRUE),LA$Accommodates)
LA$Bathrooms <-ifelse(is.na(LA$Bathrooms), median(LA$Bathrooms,na.rm=TRUE),LA$Bathrooms)
LA$Bedrooms <-ifelse(is.na(LA$Bedrooms), median(LA$Bedrooms,na.rm=TRUE),LA$Bedrooms)
LA$Maximum_nights <-ifelse(is.na(LA$Maximum_nights), median(LA$Maximum_nights,na.rm=TRUE),LA$Maximum_nights)

#drop some NA
LA<- LA %>% drop_na(Neighbourhood_cleansed)

#Create new variables
LA$Is_Apartment <- ifelse(LA$Property_type=="Apartment",1,0)
LA$Is_House <- ifelse(LA$Property_type=="House",1,0)
LA$condo <- ifelse(LA$Property_type=="Condominium",1,0)
LA$Townhouse <- ifelse(LA$Property_type=="Townhouse",1,0)
LA$Loft<- ifelse(LA$Property_type=="Loft",1,0)
LA$Guesthouse<- ifelse(LA$Property_type=="Guesthouse",1,0) 
LA$entirehouse <- ifelse(LA$Room_type=="Entire home/apt",1,0)
LA$privateroom <- ifelse(LA$Room_type=="Private room",1,0) 
LA$sharedroom <- ifelse(LA$Room_type=="Shared room",1,0)
LA$Hollywood_Neighbourhood <- ifelse(LA$Neighbourhood_cleansed=="Hollywood",1,0) 
LA$Venice_Neighbourhood <- ifelse(LA$Neighbourhood_cleansed=="Venice",1,0) 
LA$LongBeach_Neighbourhood <- ifelse(LA$Neighbourhood_cleansed=="Long Beach",1,0) 
LA$Downtown_Neighbourhood <- ifelse(LA$Neighbourhood_cleansed=="Downtown",1,0) 
LA$SantaMonica_Neighbourhood <- ifelse(LA$Neighbourhood_cleansed=="Santa Monica",1,0) 
LA$Recent_Review <-ifelse(is.na(LA$Last_Review_Date),as.Date("2020-12-31")-as.Date("2017-04-30"),as.Date("2020-12-31")-LA$Last_Review_Date)

summary(LA) 


library(splitstackshape)

#number of columns after splitting by space, find top5 amenities
Amenities<-data.frame(LA$Amenities)
colnames(Amenities)

colnames(LA_sample)

Amenities_2<-cSplit(Amenities, "LA.Amenities", ";")
colnames(Amenities_2)
Amenities_3<-Amenities_2 %>% gather(col,amenities,LA.Amenities_01:LA.Amenities_45,na.rm = T)
Amenities_3$amenities<-tolower(Amenities_3$amenities)
Amenities_3<-Amenities_3 %>% count(amenities)
Amenities_3<-Amenities_3[order(Amenities_3$n,decreasing = T),]
head(Amenities_3)

#find "24-hour check-in", "indoor fireplace", "lock on bedroom door", "pool", "elevator in building" in the LA dataset amenities
Amenities_list = c("24-hour check-in", "indoor fireplace", "lock on bedroom door", "pool", "elevator in building")
for (i in 1:length(Amenities_list)){
  LA[Amenities_list[i]]<-ifelse(grepl(Amenities_list[i],LA$Amenities,ignore.case = TRUE),1,0)
}
head(LA)

#create a subset for modeling
LA_sample<-LA[,c("Host_Response_Rate","Host_Is_Superhost","Host_total_listings_count","Accommodates","Bathrooms","Bedrooms","Price","Minimum_nights","Maximum_nights","Availability_365",
                 "Number_of_reviews","Review_Scores_Rating","Review_Scores_Accuracy",
                 "Review_Scores_Cleanliness","Review_Scores_Checkin","Review_Scores_Communication","Review_Scores_Location",
                 "Review_Scores_Value","Reviews_per_month","Is_Apartment","Is_House","condo","Townhouse","Loft","Guesthouse",
                 "Hollywood_Neighbourhood","Venice_Neighbourhood","LongBeach_Neighbourhood","Downtown_Neighbourhood","SantaMonica_Neighbourhood",
                 "entirehouse","privateroom","sharedroom","Recent_Review","24-hour check-in", "indoor fireplace", "lock on bedroom door", "pool", "elevator in building")]

#totally 39 variables
colnames(LA_sample)


#deal with too many 0 in rating
hist(LA_sample$Review_Scores_Rating)
LA_sample<-LA_sample[LA_sample$Number_of_reviews!=0&LA_sample$Review_Scores_Rating!=0,]
glimpse(LA_sample)


library(caret)

#LA SAMPLE DATA PARTITION
set.seed(13343)
train_ind <- createDataPartition(y = LA_sample$Review_Scores_Rating,p=.8,list = FALSE)
training <- LA_sample[train_ind,]
test <- LA_sample[-train_ind,]

#see correlation and check collinearity
colnames(training)
summary(training)
training_t<-training
training_t[] <- lapply(training_t, as.numeric)
correlation<-data.frame(cor(training_t))

hist(LA_sample$Review_Scores_Rating)
class(LA_sample$Review_Scores_Rating)
typeof(LA_sample$Review_Scores_Rating)


#delete review "Review_Scores_Value","Review_Scores_Accuracy","Review_Scores_Cleanliness","Review_Scores_Checkin","Review_Scores_Communication","Review_Scores_Location" and entire_house
# training<-training[,-which(names(training) %in% c("Review_Scores_Value",
#                                                   "Review_Scores_Accuracy",
#                                                   "Review_Scores_Cleanliness",
#                                                   "Review_Scores_Checkin",
#                                                   "Review_Scores_Communication",
#                                                   "Review_Scores_Location",
#                                                   "entirehouse"))]
# 
# test<-test[,-which(names(test) %in% c("Review_Scores_Value",
#                                       "Review_Scores_Accuracy",
#                                       "Review_Scores_Cleanliness",
#                                       "Review_Scores_Checkin",
#                                       "Review_Scores_Communication",
#                                       "Review_Scores_Location",
#                                       "entirehouse"))]
# 


library(janitor)

training<-training %>% clean_names()
test<-test %>% clean_names()
colnames(training)
colnames(test)

Trial_LA<-Trial_LA %>% clean_names()
Trial_LA = rbind(training,test)
colnames(Trial_LA)
dim(Trial_LA)

#variable selection using Forward-stepwise regression
library(lars)
y = training$review_scores_rating
x = training[,-which(names(training)%in%"review_scores_rating")]
x_t<-as.matrix(x)
res = lars(x_t, y, type="stepwise")
print(summary(res))
res

#cp=24.038 24 variables included, which are host_is_superhost, sharedroom, availability_365, is_apartment,
#host_total_listings_count, price accommodates, host_response_rate,maximum_nights, indoor_fireplace,
#lock_on_bedroom_door, recent_review, number_of_reviews, minimum_nights, long_beach_neighbourhood, pool,
#hollywood_neighbourhood, loft, guesthouse, reviews_per_month, bathrooms, condo, santa_monica_neighbourhood, bedrooms

#add review_scores_rating also. total 25 variables

training<-training[,c("review_scores_rating","host_is_superhost","sharedroom", "availability_365", "is_apartment",
                      "host_total_listings_count", "price", "accommodates", "host_response_rate","maximum_nights", "indoor_fireplace",
                      "lock_on_bedroom_door", "recent_review", "number_of_reviews", "minimum_nights", "long_beach_neighbourhood", "pool",
                      "hollywood_neighbourhood", "loft", "guesthouse", "reviews_per_month", "bathrooms", "condo", "santa_monica_neighbourhood","bedrooms")]


test <- test[,c("review_scores_rating","host_is_superhost","sharedroom", "availability_365", "is_apartment",
                    "host_total_listings_count", "price", "accommodates", "host_response_rate","maximum_nights", "indoor_fireplace",
                    "lock_on_bedroom_door", "recent_review", "number_of_reviews", "minimum_nights", "long_beach_neighbourhood", "pool",
                    "hollywood_neighbourhood", "loft", "guesthouse", "reviews_per_month", "bathrooms", "condo", "santa_monica_neighbourhood","bedrooms")]


cl = training$review_scores_rating
cl_test = test$review_scores_rating

dim(training)
dim(test)





#######################
#Scaling the features##
#######################

scaled_train = training
scaled_test = test

cols = c("host_is_superhost","sharedroom", "availability_365", "is_apartment",
         "host_total_listings_count", "price", "accommodates", "host_response_rate",
         "maximum_nights", "indoor_fireplace","lock_on_bedroom_door", "recent_review",
         "number_of_reviews", "minimum_nights", "long_beach_neighbourhood", "pool",
         "hollywood_neighbourhood", "loft", "guesthouse", "reviews_per_month",
         "bathrooms", "condo", "santa_monica_neighbourhood","bedrooms")


pre_proc_val <- preProcess(scaled_train[,cols], method = c("center", "scale"))

scaled_train[,cols] = predict(pre_proc_val, scaled_train[,cols])
scaled_test[,cols] = predict(pre_proc_val, scaled_test[,cols])


summary(scaled_train)

###############################
#standard multiple regression## 
###############################

lr = lm(review_scores_rating ~ host_is_superhost+sharedroom+ availability_365+ is_apartment+
            host_total_listings_count+ price+ accommodates+ host_response_rate+maximum_nights+indoor_fireplace+
            lock_on_bedroom_door+ recent_review+ number_of_reviews+ minimum_nights+ long_beach_neighbourhood+ pool+
            hollywood_neighbourhood+ loft+ guesthouse+ reviews_per_month+ bathrooms +condo+santa_monica_neighbourhood+bedrooms,
            data = scaled_train)

summary(lr)
summary(res2)

#Evaluation : Type 1
reg_pred = predict(lr, newdata = scaled_train)

MAE(reg_pred,training$review_scores_rating)
mse(reg_pred,training$review_scores_rating)
rmse(reg_pred,training$review_scores_rating)

#Evaluation : Type 2
#Step 1 - creating the evaluation metrics function
eval_metrics = function(model, df, predictions, target){
  resids = df[,target] - predictions
  resids2 = resids**2
  N = length(predictions)
  r2 = as.character(round(summary(model)$r.squared, 2))
  adj_r2 = as.character(round(summary(model)$adj.r.squared, 2))
  print(adj_r2) #Adjusted R-squared
  print(as.character(round(sqrt(sum(resids2)/N), 2))) #RMSE
}

# Step 2 - predicting and evaluating the model on train data
predictions = predict(lr, newdata = scaled_train)
eval_metrics(lr, scaled_train, predictions, target = 'review_scores_rating')


# TRAINING
# Multiple R-squared:  0.09036,
# Adjusted R-squared:  0.08921
# MAE 4.744668
# MSE 58.21413
# RMSE 7.629819
# The above output shows that RMSE, one of the two evaluation metrics,
# is 7.63 for training data. On the other hand, R-squared value is around
# 9 % for training data which indicates bad performance.


#Test
cl = training$review_scores_rating
cl_test = test$review_scores_rating

res2 = lm(review_scores_rating ~ host_is_superhost+sharedroom+ availability_365+ is_apartment+
            host_total_listings_count+ price+ accommodates+ host_response_rate+maximum_nights+indoor_fireplace+
            lock_on_bedroom_door+ recent_review+ number_of_reviews+ minimum_nights+ long_beach_neighbourhood+ pool+
            hollywood_neighbourhood+ loft+ guesthouse+ reviews_per_month+ bathrooms +condo+santa_monica_neighbourhood+bedrooms,
          data = scaled_test)

summary(res2)

#Evaluation : Type 1
reg_pred2 = predict(res2, newdata = scaled_test)

MAE(reg_pred2,test$review_scores_rating)
mse(reg_pred2,test$review_scores_rating)
rmse(reg_pred2,test$review_scores_rating)

#Evaluation : Type 2
#Step 1 - creating the evaluation metrics function
eval_metrics = function(model, df, predictions, target){
  resids = df[,target] - predictions
  resids2 = resids**2
  N = length(predictions)
  r2 = as.character(round(summary(model)$r.squared, 2))
  adj_r2 = as.character(round(summary(model)$adj.r.squared, 2))
  print(adj_r2) #Adjusted R-squared
  print(as.character(round(sqrt(sum(resids2)/N), 2))) #RMSE
}

# Step 2 - predicting and evaluating the model on test data
predictions = predict(lr, newdata = scaled_test)
eval_metrics(lr, scaled_test, predictions, target = 'review_scores_rating')

# "0.09"
# "7.79"

#The above output shows that RMSE, one of the two evaluation metrics,
#is 7.79 for test data. On the other hand, R-squared value is around 
# 9 % for test data which indicates bad performance.

#Test 
# Multiple R-squared:  0.09785
# Adjusted R-squared:  0.09325 
# MAE 5.576823
# MSE 70.35529
# RMSE 8.387806


##Regularization##  

cols_reg = c('review_scores_rating', 'host_is_superhost', 'sharedroom', 'availability_365', 'is_apartment',
             'host_total_listings_count', 'price', 'accommodates', 'host_response_rate', 'maximum_nights',
             'indoor_fireplace', 'lock_on_bedroom_door', 'recent_review','number_of_reviews','minimum_nights',
             'long_beach_neighbourhood', 'pool', 'hollywood_neighbourhood', 'loft',
             'guesthouse', 'reviews_per_month', 'bathrooms', 'condo', 'santa_monica_neighbourhood', 
             'bedrooms')

dummies <- dummyVars(review_scores_rating ~ ., data = Trial_LA[,cols_reg])

train_dummies = predict(dummies, newdata = training[,cols_reg])

test_dummies = predict(dummies, newdata = test[,cols_reg])

print(dim(train_dummies)); print(dim(test_dummies))

#######################
###Ridge Regression ### 
#######################

library(glmnet)
library(MASS)

cl = training$review_scores_rating
cl_test = test$review_scores_rating

x = as.matrix(train_dummies)
y_train = cl

x_test = as.matrix(test_dummies)
y_test = cl_test

lambdas <- 10^seq(2, -3, by = -.1)
ridge_reg = glmnet(x, y_train, nlambda = 25, alpha = 0, family = 'gaussian', lambda = lambdas)

summary(ridge_reg)

coef(ridge_reg)
plot(ridge_reg)

cv_ridge <- cv.glmnet(x, y_train, alpha = 0, lambda = lambdas)
optimal_lambda <- cv_ridge$lambda.min
optimal_lambda


# Compute R^2 from true and predicted values
eval_results <- function(true, predicted, df) {
  SSE <- sum((predicted - true)^2)
  SST <- sum((true - mean(true))^2)
  R_square <- 1 - SSE / SST
  RMSE = sqrt(SSE/nrow(df))
  
  
  # Model performance metrics
  data.frame(
    RMSE = RMSE,
    Rsquare = R_square
  )
  
}

# Prediction and evaluation on train data
predictions_train <- predict(ridge_reg, s = optimal_lambda, newx = x)
eval_results(y_train, predictions_train, scaled_train)


# Prediction and evaluation on test data
predictions_test <- predict(ridge_reg, s = optimal_lambda, newx = x_test)
eval_results(y_test, predictions_test, scaled_test)


# TEST
# RMSE 7.790958 
# Rsquare 0.09124929


#######################
###Lasso Regression ### 
#######################
x = as.matrix(train_dummies)
y_train = cl

x_test = as.matrix(test_dummies)
y_test = cl_test

lambdas <- 10^seq(2, -3, by = -.1)

# Setting alpha = 1 implements lasso regression
lasso_reg <- cv.glmnet(x, y_train, alpha = 1, lambda = lambdas, standardize = TRUE, nfolds = 25)

# Best 
lambda_best <- lasso_reg$lambda.min 
lambda_best


lasso_model <- glmnet(x, y_train, alpha = 1, lambda = lambda_best, standardize = TRUE)

# Compute R^2 from true and predicted values
eval_results <- function(true, predicted, df) {
  SSE <- sum((predicted - true)^2)
  SST <- sum((true - mean(true))^2)
  R_square <- 1 - SSE / SST
  RMSE = sqrt(SSE/nrow(df))
  
  
  # Model performance metrics
  data.frame(
    RMSE = RMSE,
    Rsquare = R_square
  )
  
}

predictions_train <- predict(lasso_model, s = lambda_best, newx = x)
eval_results(y_train, predictions_train, scaled_train)

predictions_test <- predict(lasso_model, s = lambda_best, newx = x_test)
eval_results(y_test, predictions_test, scaled_test)

#TRAIN
#RMSE    
#7.62982
#Rsquare
#0.09035994

#TEST
#RMSE    
#7.79091 
#Rsquare
#0.09126056


##############################
###Elastic Net Regression #### 
##############################

install.packages("repr")
library(repr)

# Set training control
train_cont <- trainControl(method = "repeatedcv",
                           number = 10,
                           repeats = 5,
                           search = "random",
                           verboseIter = TRUE)

# Train the model
elastic_reg <- train(review_scores_rating~.,
                     data = training,
                     method = "glmnet",
                     preProcess = c("center", "scale"),
                     tuneLength = 10,
                     trControl = train_cont)


# Best tuning parameter
elastic_reg$bestTune

x = as.matrix(train_dummies)
y_train = cl

x_test = as.matrix(test_dummies)
y_test = cl_test

# Make predictions on training set
predictions_train <- predict(elastic_reg, x)
eval_results(y_train, predictions_train, scaled_train) 

# Make predictions on test set
predictions_test <- predict(elastic_reg, x_test)
eval_results(y_test, predictions_test, scaled_test)

#TRAINING
# RMSE   
# 7.629835
# Rsquare
# 0.09035642

#TEST
#RMSE    
#7.790872 
#Rsquare
#0.09126945





